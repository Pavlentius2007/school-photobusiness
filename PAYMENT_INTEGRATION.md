# Интеграция системы оплаты с админкой

## Обзор

Данный документ описывает требования и план реализации интеграции системы оплаты с админ-панелью для управления платежами, клиентами и чеками.

## Текущее состояние

✅ **Реализовано:**
- Создана страница "Оплата" (`/payment`)
- Отображение реквизитов компании
- Описание способов оплаты (QR-код, банковский перевод, рассрочка)
- Интеграция с Telegram для консультаций
- Обновлена навигация (заменена "Контакты" на "Оплата")

## Требования к интеграции с админкой

### 1. Модели данных

#### Платеж (Payment)
```typescript
interface Payment {
  id: number;
  user_id: number;
  course_id: number;
  amount: number;
  currency: string;
  payment_method: 'qr_code' | 'bank_transfer' | 'installment';
  status: 'pending' | 'completed' | 'failed' | 'refunded';
  receipt_url?: string;
  transaction_id?: string;
  created_at: Date;
  updated_at: Date;
}
```

#### Чек (Receipt)
```typescript
interface Receipt {
  id: number;
  payment_id: number;
  user_id: number;
  file_url: string;
  file_name: string;
  file_size: number;
  uploaded_at: Date;
}
```

### 2. Функциональность админки

#### 2.1 Управление платежами
- **Просмотр всех платежей** с фильтрацией по статусу, дате, пользователю
- **Изменение статуса платежа** (подтверждение, отмена, возврат)
- **Привязка платежа к пользователю** (если платеж поступил без указания пользователя)
- **Просмотр деталей платежа** (реквизиты, история изменений)

#### 2.2 Управление чеками
- **Загрузка чеков** об оплате (drag & drop или выбор файла)
- **Привязка чека к платежу** и пользователю
- **Просмотр загруженных чеков** с возможностью скачивания
- **Валидация чеков** (проверка суммы, даты, реквизитов)

#### 2.3 Отчетность
- **Отчеты по платежам** (общая сумма, количество, статистика по методам)
- **Отчеты по пользователям** (кто оплатил, кто не оплатил)
- **Экспорт данных** в Excel/CSV

### 3. API Endpoints

#### Платежи
```
GET    /api/admin/payments          - Список всех платежей
GET    /api/admin/payments/:id      - Детали платежа
PUT    /api/admin/payments/:id      - Обновление статуса платежа
POST   /api/admin/payments/:id/link - Привязка к пользователю
```

#### Чеки
```
GET    /api/admin/receipts          - Список всех чеков
POST   /api/admin/receipts          - Загрузка чека
GET    /api/admin/receipts/:id      - Детали чека
DELETE /api/admin/receipts/:id      - Удаление чека
```

#### Отчеты
```
GET    /api/admin/reports/payments  - Отчет по платежам
GET    /api/admin/reports/users     - Отчет по пользователям
```

### 4. Интерфейс админки

#### 4.1 Страница управления платежами
- Таблица с платежами (ID, пользователь, курс, сумма, статус, дата)
- Фильтры (статус, дата, пользователь, курс)
- Поиск по ID платежа или имени пользователя
- Массовые операции (изменение статуса, экспорт)

#### 4.2 Страница управления чеками
- Галерея загруженных чеков
- Форма загрузки новых чеков
- Привязка чеков к платежам
- Предварительный просмотр чеков

#### 4.3 Дашборд с аналитикой
- Графики поступления платежей
- Статистика по методам оплаты
- Конверсия (заявки → оплаты)
- Выручка по курсам

### 5. Автоматизация

#### 5.1 Уведомления
- **Email уведомления** при поступлении платежа
- **Telegram уведомления** для администратора
- **Уведомления пользователю** о подтверждении оплаты

#### 5.2 Автоматические действия
- **Активация доступа** к курсу после подтверждения оплаты
- **Отправка приветственного письма** после оплаты
- **Создание записи** в системе учета

### 6. Безопасность

#### 6.1 Валидация платежей
- Проверка суммы платежа
- Проверка реквизитов плательщика
- Дублирование платежей

#### 6.2 Защита данных
- Шифрование персональных данных
- Логирование всех операций
- Резервное копирование чеков

## План реализации

### Этап 1: База данных (1-2 дня)
- [ ] Создание таблиц `payments` и `receipts`
- [ ] Миграции для существующих данных
- [ ] Индексы для оптимизации запросов

### Этап 2: API (2-3 дня)
- [ ] Реализация CRUD операций для платежей
- [ ] Реализация CRUD операций для чеков
- [ ] API для отчетов и аналитики

### Этап 3: Админ-интерфейс (3-4 дня)
- [ ] Страница управления платежами
- [ ] Страница управления чеками
- [ ] Дашборд с аналитикой
- [ ] Интеграция с существующей админкой

### Этап 4: Автоматизация (1-2 дня)
- [ ] Система уведомлений
- [ ] Автоматические действия
- [ ] Интеграция с Telegram

### Этап 5: Тестирование (1-2 дня)
- [ ] Unit тесты для API
- [ ] Интеграционные тесты
- [ ] Тестирование UI
- [ ] Нагрузочное тестирование

## Технические требования

### Backend
- **FastAPI** для API
- **SQLAlchemy** для работы с БД
- **Alembic** для миграций
- **Celery** для фоновых задач
- **Redis** для кэширования

### Frontend
- **React** для админ-интерфейса
- **TypeScript** для типизации
- **React Query** для управления состоянием
- **React Hook Form** для форм
- **Chart.js** для графиков

### Инфраструктура
- **Docker** для контейнеризации
- **PostgreSQL** для основной БД
- **MinIO/S3** для хранения файлов
- **Nginx** для проксирования

## Следующие шаги

1. **Согласование требований** с заказчиком
2. **Создание технического задания** для разработчиков
3. **Настройка окружения** для разработки
4. **Начало разработки** с баз данных

## Контакты

- **Разработчик:** [Имя разработчика]
- **Менеджер проекта:** [Имя менеджера]
- **Дата создания:** [Дата]
- **Версия документа:** 1.0 